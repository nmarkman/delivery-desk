# PRD: Sync Act! Products into DeliveryDesk and Integrate with Invoice Line Items

## 1. Introduction/Overview

CRCG currently uses Act! CRM to manage opportunities and associated products that represent billable line items such as retainers, deliverables, and deposits. This feature adds support for syncing product line items from Act! into the tool's Supabase database, with the goal of enabling automated invoice creation, deliverables tracking, and billing timeline visibility.

The synced data will populate and/or upsert into the invoice_line_items table, ensuring a unified source of truth for all future invoicing, regardless of whether line items were created through the Act! CRM or the contract uploader workflow inside DeliveryDesk.

## 2. Goals
- Import Act! opportunity products via API and upsert them into Supabase
- Leverage invoice_line_items as the canonical table for all billable line items
- Ensure integrity of Act! product IDs and prevent duplication
- Only include line items from active opportunities
- Ensure invoice line items can be associated with invoices after the sync occurs (invoice id not required upon creation, but can be re-assigned later)
- Normalize itemNumber into a date (billed_at) and exclude invalid records

## 3. User Stories
- As a system, I want to fetch product line items from active Act! opportunities so they can be used in invoices.
- As a user, I want to associate synced Act! products with invoices later, so that billing is flexible.
- As a user, I want to rely on synced product data (e.g., deliverables and retainers) to match contract expectations.

## 4. Functional Requirements
1. The system must call GET /api/opportunities/{opportunityId}/products for each active opportunity.
2. For each returned product:
   - If itemNumber is missing or not parsable as a valid date, the product must be skipped.
   - If the product already exists in Supabase (matching on Act! id), it must be updated (upsert behavior).
   - Products must only be inserted if their associated opportunity is active.
3. Each product will be mapped to a record in invoice_line_items using the following rules:
   - id: generated by Supabase (UUID)
   - act_reference: set to the Act! product id
   - description: set to Act! product name
   - quantity: Act! quantity
   - unit_rate: Act! price
   - line_total: derived as quantity * unit_rate (might be returned as such from act! API, we should test the API call first to see how data is returned and refine this process)
   - billed_at: parsed from Act! itemNumber (assumed to be a date string)
   - opportunity_id: linked via Act! product's opportunityID
   - invoice_id: nullable (set by invoice creation logic later)
4. The sync should not insert products that:
   - Are missing a valid itemNumber (date string)
   - Belong to archived/inactive opportunities
5. The sync must not overwrite any custom tool-specific values (e.g. invoice_id) unless explicitly mapped.
6. Supabase triggers for line_total, updated_at, and other business logic must continue to function.

## 5. Non-Goals (Out of Scope)
- UI components showing synced invoice line items
- Invoice generation or assignment logic
- Manual editing of synced Act! products in the DB
- Write-back to Act! CRM (e.g., updating products)
- Handling QuickBooks integration fields

## 6. Design Considerations (Optional)
- This table is dual-purpose: it stores both Act! synced products and those created directly by the tool (e.g. through contract upload - will add later).
- Product creation via contract upload will use the same format and logic, ensuring consistency across workflows.
- We will rely on act_reference as the unique identifier for Act! product records.
- The opportunity status will be determined via Act! opportunity metadata, already synced elsewhere in the database.

## 7. Technical Considerations (Optional)
- Consider creating a Supabase index on act_reference for upsert performance.
- Consider whether the opportunity status (active/inactive) should be cached or fetched live.
- The sync function will be deployed as a Supabase Edge Function and should run as a part of the existing act-sync edge function
- May want to introduce a source column on invoice_line_items to differentiate Act! vs tool-created records.

## 8. Success Metrics
- 100% of Act! products with valid dates are synced into Supabase
- No duplicate act_reference entries created
- Products are available for invoice creation within 30 seconds of sync

## 9. Open Questions
- Should we backfill productID and type from Act! into separate columns?
    - account for this yes
- Should we store Act! createdDate or editedDate for debugging/versioning?
    - if it's returned from the API sure but if not dont worry about it
- Do we need a synced_at timestamp column for record freshness tracking?
    - if easy sure
- Would it help to create a lightweight view or materialized view specifically for invoiceable line items?
    - out of scope
