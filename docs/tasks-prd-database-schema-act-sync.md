## Relevant Files

- `supabase/functions/act-sync/index.ts` - Main Edge Function for Act! CRM API synchronization (DEPLOYED)
- `supabase/functions/daily-sync/index.ts` - **NEW** Edge Function for automated daily sync of all active connections (DEPLOYED)
- `supabase/functions/act-sync/types.ts` - TypeScript types for Act! API responses and database models  
- `supabase/functions/act-sync/act-client.ts` - Act! API client with per-user authentication and request handling
- `supabase/migrations/20250817151545_add_daily_sync_settings_fixed.sql` - **NEW** Daily sync database schema migration
- `src/components/ActSyncButton.tsx` - UI component for manual sync trigger
- `src/components/DailySyncSettings.tsx` - **NEW** UI component for managing daily sync preferences
- `src/pages/ActConnection.tsx` - Page for single Act! connection management and testing
- `src/components/ActConnectionForm.tsx` - Form for setting user's Act! connection credentials
- `src/lib/act-sync.ts` - Client-side utilities for sync operations
- `docs/act-api-exploration.md` - Documentation of Act! API data structure analysis

### Notes

- Edge Functions in Supabase use Deno runtime, not Node.js
- All database migrations should include proper RLS policies
- Each user has exactly one Act! connection (1:1 relationship)
- Act! API credentials are stored per-user in user_act_connections table (encrypted)
- Edge Functions must accept user_id parameter instead of using hardcoded environment variables

## Tasks

- [x] 1.0 Set Up Act! API Connection & Exploration
  - [x] 1.1 Configure Act! trial account credentials in Supabase environment variables (ACT_USERNAME, ACT_PASSWORD, ACT_DATABASE_NAME) - DEPRECATED: replaced by per-user connections
  - [x] 1.2 Create basic Supabase Edge Function structure at `supabase/functions/act-sync/index.ts`
  - [x] 1.3 Implement Act! authentication flow to obtain bearer token from `/act.web.api/authorize`
  - [x] 1.4 Test basic API connectivity with a simple endpoint call
  - [x] 1.5 Verify `Act-Database-Name` header is properly included in requests

- [x] 2.0 Analyze Act! Data Structure & Document Findings
  - [x] 2.1 Make test API call to `GET /api/opportunities` and log complete response structure
  - [x] 2.1.1 Determine based on `opportunities` data if fetching companies data is required and evaluate relationship between opportunities and companies
  - [x] 2.2 Make test API call to `GET /api/tasks` and log complete response structure (COMPLETE - found 4 activity types: Meeting, Appointment, Call, To-do)  
  - [x] 2.2.1 Create custom task types in Act! trial account for DeliveryDesk-specific tasks (e.g., "Billing") and test API response
  - [x] 2.3 Analyze JWT token expiration and implement token refresh strategy in Edge Function
  - [x] 2.4 Create `docs/act-api-exploration.md` documenting all response fields and structure in user-friendly format
  - [x] 2.5 Identify which Act! opportunity fields map to DeliveryDesk requirements (client name, contact info, retainer amounts, contract dates)
  - [x] 2.6 Determine if custom opportunity fields need to be created in Act! for retainer tracking
  - [x] 2.7 Assess whether separate accounts API calls are needed or if opportunity data includes company info

- [x] 3.0 Design Enhanced Database Schema
  - [x] 3.1 Create invoice status enum (draft, invoiced, paid, overdue)
  - [x] 3.2 Create `opportunities` table with Act! opportunity ID, client info, retainer amount, contract dates
  - [x] 3.3 Create `deliverables` table linked to opportunities with fee amount, dates, and Act! task ID
  - [x] 3.4 Create `invoices` table with opportunity reference, billing period, amounts, dates, and status
  - [x] 3.5 Create `invoice_line_items` table for itemized invoice entries (retainer + deliverables)
  - [x] 3.6 Create `integration_logs` table for sync timestamps, errors, and API call details
  - [x] 3.6.1 Create `user_act_connections` table for single Act! connection per user (1:1 relationship)
  - [x] 3.7 Add proper foreign key relationships and constraints between all tables
  - [x] 3.8 Implement Row Level Security (RLS) policies for all new tables
  - [x] 3.9 Add database indexes on frequently queried fields (Act! IDs, invoice dates, client lookup)
  - [x] 3.10 Update Supabase TypeScript types by running type generation

- [x] **4.0 Implement Act! Sync Edge Function** ✅ **COMPLETED**
    - [x] 4.0.1 Update Edge Function to accept user_id parameter and query user's single Act! connection
    - [x] 4.0.2 Implement credential encryption/decryption for stored Act! passwords
    - [x] 4.0.3 Replace hardcoded environment variables with user-specific credentials from database
    - [x] 4.1 Create `act-client.ts` module with user-specific authentication, rate limiting, and request handling
    - [x] 4.2 Create TypeScript types in `types.ts` for Act! API responses and database models
    - [x] 4.3 Implement opportunities sync logic with upsert operations to `opportunities` table** ✅ **COMPLETED**
      - Successfully implemented comprehensive data mapping from Act! opportunities to database schema
      - Handles missing/malformed data gracefully with fallback values and warnings
      - Implements proper upsert logic using `act_opportunity_id` as conflict resolution
      - Processes records in batches (default 50) for performance
      - Maps custom fields for retainer data per field mapping strategy
      - Calculates total contract values when missing using retainer amounts and date ranges
      - Provides detailed sync operation results with success/failure tracking
      - **Status**: ✅ Successfully tested with 5 opportunities synced from Act! CRM
    - [x] **4.4 Implement tasks sync logic filtering for deliverable-specific task types** ✅ **COMPLETED**
      - Successfully implemented intelligent task filtering using activity types and keywords
      - Filters for billable tasks: 'Billing', 'To-do', 'Meeting', 'Call', etc.
      - Implements fee parsing from task subject/details using regex patterns
      - Links tasks to opportunities via Act! relationships and company matching
      - Maps Act! task completion status to deliverable statuses (pending, in_progress, completed)
      - Handles priority mapping from Act! priority levels
      - Removed client_id foreign key constraint - deliverables now link via opportunity_id
      - **Status**: ✅ Successfully tested with 23 billable tasks synced from Act! CRM to deliverables
    - [x] **4.5 Add rate limiting with appropriate delays between API requests** ✅ **COMPLETED**
      - Implemented per-user rate limiting (100 calls per minute)
      - Automatic waiting between requests (100ms minimum interval)
      - Rate limit status tracking and enforcement
      - **Status**: ✅ Already implemented in ActClient
    - [x] **4.6 Implement retry logic with exponential backoff for failed API calls** ✅ **COMPLETED**
      - Automatic token refresh on 401 Unauthorized responses
      - Retry logic with max 2 attempts per API call
      - Comprehensive error handling and categorization
      - **Status**: ✅ Already implemented in ActClient makeApiCall method
    - [x] **4.7 Calculate monthly retainer amounts by dividing contract value by months between start/end dates** ✅ **COMPLETED** (DEPRECATED)
      - Implemented in opportunities sync with automatic calculation when retainer amount and contract dates are available
      - Uses average month length (30.44 days) for accurate calculation
      - Provides warnings when calculation is performed vs using direct productTotal
      - **Status**: ✅ Already implemented in opportunities-sync.ts
      - **Note**: This approach is being replaced with direct monthly retainer amount storage
    - [x] **4.8 Map Act! task data to `deliverables` table, parsing fee amounts from task names/descriptions** ✅ **COMPLETED**
      - Comprehensive fee parsing using multiple regex patterns ($1,000.00, fee: $500, etc.)
      - Maps all relevant Act! task fields to deliverable schema
      - Intelligent status and priority mapping
      - **Status**: ✅ Already implemented in tasks-sync.ts
    - [x] **4.9 Store raw Act! response data in JSON fields for debugging and future feature development** ✅ **COMPLETED**
      - Raw Act! data stored in `act_raw_data` field for both opportunities and deliverables
      - Enables debugging and future feature development without re-fetching from Act!
      - **Status**: ✅ Already implemented in both sync modules

- [x] **5.0 Create Manual Sync UI Components**
  - [x] 5.0.1 Create UI component for manual sync triggers with operation type selection
  - [x] 5.0.2 Add connection testing functionality to verify user's Act! credentials
  - [x] 5.0.3 Add credential validation and regional endpoint selection

- [x] **6.0 Implement Daily Automated Sync** ✅ **COMPLETED (Aug 2025)**
  - [x] **6.1 Database Schema Enhancement** ✅ **COMPLETED**
    - Added daily sync settings columns to `user_act_connections` table
    - Added batch operation tracking to `integration_logs` table
    - Created database functions for batch sync management
    - **Status**: ✅ Migration `20250817151545_add_daily_sync_settings_fixed.sql` deployed
  - [x] **6.2 Daily Sync Edge Function** ✅ **COMPLETED**
    - Created `supabase/functions/daily-sync/index.ts` for batch processing
    - Implemented fault-tolerant sync processing with error isolation
    - Added comprehensive batch logging and progress tracking
    - Rate limiting and sequential processing to respect Act! API limits
    - **Status**: ✅ Function deployed and active
  - [x] **6.3 Database Functions** ✅ **COMPLETED**
    - `get_connections_ready_for_sync()` - Get all active connections ready for daily sync
    - `update_next_sync_time()` - Schedule next sync time for a connection
    - `update_daily_sync_status()` - Update connection sync status and error tracking
    - **Status**: ✅ Functions deployed with correct UUID types
  - [x] **6.4 Daily Sync UI Controls** ✅ **COMPLETED**
    - Created `DailySyncSettings.tsx` component for user preferences
    - Added daily sync tab to SyncDashboard with toggle controls
    - Configurable sync time and enable/disable functionality
    - Manual "Run Now" trigger for immediate batch sync
    - **Status**: ✅ UI components implemented and integrated
  - [x] **6.5 Batch Processing Features** ✅ **COMPLETED**
    - Sequential processing with 2-second delays between connections
    - Individual connection error handling without stopping batch
    - Comprehensive batch result tracking and reporting
    - Integration with existing ActClient for authentication and sync operations
    - **Status**: ✅ Implemented in daily-sync Edge Function
  - [x] 5.1 Create ActConnectionForm.tsx component for setting user's single Act! connection
  - [x] 5.2 Create SyncDashboard.tsx to display sync status, trigger manual syncs, and show recent sync history
  - [x] 5.3 Create SyncResultsDisplay.tsx to show detailed sync results including success/failure counts and warnings

- [ ] 6.0 Set Up Automated Daily Sync
  - [ ] 6.1 Configure Supabase cron job to run daily sync for all users with active connections
  - [ ] 6.2 Create separate scheduled function entry point that calls the main sync logic
  - [ ] 6.3 Test automated sync execution and verify it runs on schedule
  - [ ] 6.4 Add logging to track automated sync execution and results

- [ ] 7.0 Implement Error Handling & Logging
  - [ ] 7.1 Enhance integration_logs table usage throughout sync process
  - [ ] 7.2 Log all API calls with request/response details (without exposing credentials)
  - [ ] 7.3 Implement graceful handling of partial sync failures
  - [ ] 7.4 Add validation for required fields before creating database records
  - [ ] 7.5 Handle missing or invalid Act! data with appropriate default values and warnings
  - [ ] 7.6 Log Act! opportunities that don't map to expected DeliveryDesk structure

- [ ] 8.0 Testing & Validation
  - [x] 8.1 Test Act! API authentication with user-specific credentials (trial and production)
  - [x] 8.2 Verify opportunities sync creates proper records in database
  - [ ] 8.3 Verify tasks sync correctly filters and maps deliverable tasks
  - [x] 8.4 Test manual sync trigger from UI works correctly
  - [ ] 8.5 Test automated daily sync executes on schedule
  - [ ] 8.6 Validate data integrity and foreign key relationships
  - [ ] 8.7 Test error scenarios (API failures, invalid data, rate limiting)
  - [ ] 8.8 Verify RLS policies properly isolate user data
  - [ ] 8.9 Test upsert functionality with changed Act! data
  - [ ] 8.10 Document any recommended Act! custom fields or task types for Russell to configure

- [x] **9.0 Update Retainer Amount Logic** ✅ **COMPLETED**
  - [x] 9.1 Update database schema to clarify retainer_amount field stores monthly amount
  - [x] 9.2 Modify opportunities-sync.ts to remove monthly calculation logic
  - [x] 9.3 Update field mapping documentation to reflect monthly retainer amount storage
  - [x] 9.4 Update Act! custom field recommendations to specify monthly retainer amount
  - [x] 9.5 Test sync with new retainer amount logic
    - ✅ Successfully tested retainer amount detection from `opportunity_field_3`
    - ✅ Smart field detection working across all `opportunity_field_X` fields
    - ✅ Fixed database constraint issues with sync_status values
    - ✅ Deployed updated edge function with improved logic
    - ✅ Verified $5,000.00 monthly retainer correctly stored in database
  - [x] 9.5.1 Fix database constraint errors with sync_status field
    - ✅ Updated opportunities-sync.ts to use 'synced' instead of 'completed'
    - ✅ Updated SYNC_STATUSES in types.ts for database compatibility
    - ✅ Tested successful sync with 6 opportunities updated, 0 errors
  - [x] 9.5.2 Implement smart custom field detection for Act! integration
    - ✅ Added intelligent retainer amount detection across all opportunity_field_X
    - ✅ Added smart date field detection with fallback logic
    - ✅ Successfully extracted retainer data from user's Act! configuration
  - [ ] 9.6 Update UI components to display monthly retainer amounts correctly
  - [ ] 9.7 Verify invoice generation uses monthly retainer amounts properly
